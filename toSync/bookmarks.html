<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bookmarks</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg: #0f151e;
            --panel: #111827;
            --muted: #9aa4b2;
            --text: #e5e7eb;
            --accent: #60a5fa;
            --border: #1f2937;
            --bgfolder: #192330;
            --bgitem: #314258;
        }
        html, body { height: 100%; }
        body {
            background-color: var(--bg);
            min-height: 100%;
            margin: 0px; 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
            font-size: 14px;
            color: var(--text);
        }
        
        main { padding: 16px; }

        .viewer { padding: 0px; overflow: auto; }
        ul.tree { list-style: none; padding-left: 0; margin: 0; }
        ul li { padding: 10px 015px; border-radius: 6px; background-color: var(--bgitem); margin: 10px 0px; }
        ul li.liRoot { background-color: transparent !important; margin: 0px; padding: 0px; border:none; }
        ul li.liFolder { background-color: var(--bgfolder); }
        ul li.liFolder:hover {  background-color: color-mix(in srgb, var(--bgfolder) 95%, white); cursor: pointer; -webkit-tap-highlight-color: transparent; }

        .children { margin-left: 8px; border-left: 1px dashed #263246; padding-left: 13px; }
        
        .caret { user-select: none; font-size: 14px; text-align: center; }
        .caret::before { content: '\25B6'; display: inline-block; margin-right: 10px; transform: rotate(0deg); transition: transform 120ms ease; }
        .caret.open::before { transform: rotate(90deg); }

        .node { display: grid;  align-items: center; }
        
        .node:not(.bookmark) { grid-template-columns: 30px 1fr auto; grid-template-rows: auto auto; gap:4px; }
        
        .node:not(.bookmark) .title { font-size: 16px; font-weight: bold; }
        .node.folder:not(.bookmark) .count { font-size: 0.75em; color: var(--muted); }

        .node.bookmark { grid-template-columns: 35px 1fr; grid-template-rows: auto auto; gap:0px; }
        .node.bookmark img       { grid-row: 1 / 3; grid-column: 1 / 2; width: 22px; vertical-align: middle; }
        .node.bookmark .title    { grid-row: 1 / 2; grid-column: 2 / 3;  font-size: 0.90em; overflow-wrap: break-word; }
        .node.bookmark .count    { grid-row: 2 / 3; grid-column: 2 / 3;  font-size: 0.75em; overflow-wrap: break-word; color: var(--muted); }

        a.link { color: var(--text); text-decoration: none; }
        a.link:hover { color: var(--accent); text-decoration: underline; }

        .empty { color: var(--muted); padding: 12px; }

    </style>
</head>
<body>
    
    <main>
        <section class="viewer">
            <ul class="tree" id="tree"></ul>
            <div class="empty" id="emptyState">No data loaded.</div>
        </section>
    </main>

    <script src="bookmarks_data.js"></script>
    <script>

        const $tree = $('#tree');
        const $empty = $('#emptyState');
        const $totals = $('#totals');

        const isFolder = (n) => n && n.type === 'folder';
        const isBookmark = (n) => n && (n.type === 'url' || (n.url && !n.children));

        function rootsFrom(data) {
            if (!data || !data.roots) return [];

            return Object.entries(data.roots)
                .filter(([_, value]) => Array.isArray(value.children) && value.children.length > 0)
                .map(([key, value]) => ({ key, ...value }));
        }


        function countNodes(node){
            let folders=0, links=0;
            function walk(n){
                if(isFolder(n)){ folders++; (n.children||[]).forEach(walk); }
                else if(isBookmark(n)){ links++; }
            }
            walk(node);
            return { folders, links };
        }

        function buildFolderNode(folder){
            const id = 'f_' + Math.random().toString(36).slice(2,9);
            const $li = $('<li class="liFolder">');
            const { folders, links } = countNodes(folder);
            const $row = $('<div class="node folder">');
            const $caret = $('<span class="caret" aria-label="toggle" role="button" tabindex="0"></span>');
            const $title = $('<span class="title"></span>').text(folder.name || '(folder)');
            const $count = $('<span class="count"></span>').text(`${folders-1} folders · ${links} link`);
            const $children = $('<ul class="children" hidden></ul>').attr('id', id);

            $row.append($caret, $title, $count);
            $li.append($row, $children);

            $row.on('click keydown', (e)=>{ if(e.type==='click' || e.key==='Enter' || e.key===' '){ $caret.toggleClass('open'); $children.prop('hidden', !$children.prop('hidden')); }});

            (folder.children||[]).forEach(child => {
                if(isFolder(child)) $children.append(buildFolderNode(child));
                else if(isBookmark(child)) $children.append(buildBookmarkNode(child));
            });

            return $li;
        }

        function buildBookmarkNode(bm) {

            const $li = $('<li>');
            const $row = $('<div class="node bookmark">');

            const $title = $('<span class="title"></span>');
            const $details = $('<span class="count"></span>');
            const title = bm.name || bm.url || '(blank title)';
            const url = bm.url || '#';
            const favicon = bm.favicon || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAAXNSR0IArs4c6QAAANFJREFUSEtjZKAxYKSx+QwDY8H9+/cNWFhYzpPiuz9//mgqKireQNeD1QePHz/+T4rhMLWysrIY5uG1AJsGbBbDHDRqAc5oGQ0igil2NIiGSRA9efJk+v///zNA3mFkZFwgIyOTCPMa2ZH8588fSWipKoEjnF6ASlEWFpb3IHmSyyI0Q0/8+fPHESTGwsKynYGBwQHdUnItaABqbMRRitYDxRvIKq4ZGRktZWRkThBMQgwMDE+ePLH4////fllZWU6iKhxiDCVWzcDUycS6jhh1AE5lnxnG/RVzAAAAAElFTkSuQmCC';
            const $favicon = $(`<img src="${favicon}"/>`);
            $title.append($('<a class="link" target="_blank" rel="noopener noreferrer"></a>').attr('href', url).text(title));
            
            try {
                const u = new URL(url);
                $details.text(u.hostname);
            } catch(_) { $details.text(''); }

            $row.append($favicon, $title, $details);
            $li.append($row);
            return $li;
        }

        function render(data){
            $tree.empty();
            if(!data){ $empty.show(); return; }
            $empty.hide();
            const rts = rootsFrom(data);
            let totalLinks=0, totalFolders=0;
            rts.forEach(rt => {

                const {folders, links} = countNodes(rt);

                const $section = $('<li class="liRoot">');
                const $header = $('<div class="node" style="font-weight:600"></div>');
                const label = rt.name;
                $header.append('<span class="caret open"></span>');
                $header.append($('<span class="title"></span>').text(label));
                
                totalLinks += links; totalFolders += folders; 
                $header.append($('<span class="count"></span>').text(`${folders-1} folders · ${links} link`));
                const $children = $('<ul class="children"></ul>');
                (rt.children||[]).forEach(child => {
                    if(isFolder(child)) $children.append(buildFolderNode(child));
                    else if(isBookmark(child)) $children.append(buildBookmarkNode(child));
                });
                $section.append($header, $children);
                $tree.append($section);
            });
            $('#statLinks').text(totalLinks);
            $('#statFolders').text(Math.max(0,totalFolders - rootsFrom(data).length));
            $('#statRoots').text(rts.length);
            $totals.text(`${totalLinks} link · ${Math.max(0,totalFolders - rts.length)} folders`);
        }

        render(window.BOOKMARKS_JSON);

    </script>
</body>
</html>
